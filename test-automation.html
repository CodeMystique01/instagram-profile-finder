<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Automation Flow</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            color: #4ec9b0;
        }
        .step {
            background: #252526;
            border-left: 4px solid #4ec9b0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .step.loading {
            border-left-color: #dcdcaa;
        }
        .step.error {
            border-left-color: #f48771;
        }
        .step.success {
            border-left-color: #4ec9b0;
        }
        .step-title {
            font-weight: bold;
            color: #4ec9b0;
            margin-bottom: 5px;
        }
        .step-content {
            color: #d4d4d4;
            white-space: pre-wrap;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            margin: 20px 0;
        }
        button:hover {
            background: #1177bb;
        }
        input {
            padding: 10px;
            width: 300px;
            border: 1px solid #3e3e42;
            background: #252526;
            color: #d4d4d4;
            border-radius: 5px;
            margin-right: 10px;
        }
        .result {
            background: #252526;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .ad-count {
            font-size: 32px;
            color: #4ec9b0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ü§ñ Instagram ‚Üí Gemini AI ‚Üí BrandBooster Automation Test</h1>
    
    <div>
        <input type="text" id="username" placeholder="Enter Instagram username" value="amazondotin">
        <button onclick="testAutomation()">Test Automation</button>
    </div>

    <div id="steps"></div>
    <div id="result"></div>

    <script>
        async function testAutomation() {
            const username = document.getElementById('username').value.trim();
            const stepsDiv = document.getElementById('steps');
            const resultDiv = document.getElementById('result');
            
            stepsDiv.innerHTML = '';
            resultDiv.innerHTML = '';

            try {
                // STEP 1: Fetch Instagram Profile
                addStep('step1', 'Step 1: Fetching Instagram Profile', 'loading');
                updateStep('step1', `Fetching profile for: @${username}`, 'loading');
                
                const instagramData = await fetchInstagramProfile(username);
                const profileName = instagramData.full_name || username;
                
                updateStep('step1', `‚úÖ SUCCESS!\nUsername: @${username}\nProfile Name: ${profileName}\nFollowers: ${formatNumber(instagramData.edge_followed_by?.count || 0)}`, 'success');

                // STEP 2: Extract Brand Name with Gemini AI
                addStep('step2', 'Step 2: Extracting Brand Name with Gemini AI', 'loading');
                updateStep('step2', `Input to Gemini: "${profileName}"`, 'loading');
                
                const brandName = await extractBrandNameWithGemini(profileName);
                
                updateStep('step2', `‚úÖ SUCCESS!\nInput: "${profileName}"\nAI Extracted: "${brandName}"`, 'success');

                // STEP 3: Fetch Ad Data from BrandBooster
                addStep('step3', 'Step 3: Fetching Ad Data from BrandBooster', 'loading');
                updateStep('step3', `Searching for ads: "${brandName}"`, 'loading');
                
                const adData = await fetchAdData(brandName);
                
                updateStep('step3', `‚úÖ SUCCESS!\nTotal Ads: ${adData.total_ad_count}\nActive Ads: ${adData.active_ad_count}\nInactive Ads: ${adData.inactive_ad_count}`, 'success');

                // DISPLAY FINAL RESULT
                resultDiv.innerHTML = `
                    <div class="result">
                        <h2>üéâ Automation Complete!</h2>
                        <p><strong>Instagram Username:</strong> @${username}</p>
                        <p><strong>Profile Name:</strong> ${profileName}</p>
                        <p><strong>AI-Extracted Brand:</strong> ${brandName}</p>
                        <hr style="border-color: #3e3e42; margin: 20px 0;">
                        <h3>üìä Ad Statistics for "${brandName}":</h3>
                        <p>Total Ads: <span class="ad-count">${formatNumber(adData.total_ad_count)}</span></p>
                        <p>Active Ads: <span class="ad-count">${formatNumber(adData.active_ad_count)}</span></p>
                        <p>Inactive Ads: <span class="ad-count">${formatNumber(adData.inactive_ad_count)}</span></p>
                    </div>
                `;

            } catch (error) {
                const lastStep = document.querySelector('.step.loading');
                if (lastStep) {
                    updateStep(lastStep.id, `‚ùå ERROR: ${error.message}`, 'error');
                }
            }
        }

        function addStep(id, title, status) {
            const stepsDiv = document.getElementById('steps');
            const stepDiv = document.createElement('div');
            stepDiv.id = id;
            stepDiv.className = `step ${status}`;
            stepDiv.innerHTML = `
                <div class="step-title">${title}</div>
                <div class="step-content" id="${id}-content"></div>
            `;
            stepsDiv.appendChild(stepDiv);
        }

        function updateStep(id, content, status) {
            const stepDiv = document.getElementById(id);
            const contentDiv = document.getElementById(`${id}-content`);
            if (stepDiv && contentDiv) {
                stepDiv.className = `step ${status}`;
                contentDiv.textContent = content;
            }
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num?.toLocaleString() || '0';
        }

        async function fetchInstagramProfile(username) {
            try {
                const response = await fetch(`https://www.instagram.com/api/v1/users/web_profile_info/?username=${username}`, {
                    headers: {
                        'User-Agent': 'Mozilla/5.0',
                        'X-IG-App-ID': '936619743392459'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.data?.user) return data.data.user;
                }
            } catch (error) {
                console.warn('Instagram API failed:', error);
            }

            // Fallback
            return {
                username: username,
                full_name: username.charAt(0).toUpperCase() + username.slice(1),
                profile_pic_url: 'https://via.placeholder.com/80',
                edge_followed_by: { count: 0 }
            };
        }

        async function extractBrandNameWithGemini(profileName) {
            try {
                const GEMINI_API_KEY = 'AIzaSyAHY8-W3rmJzvARGUgTaZvFOFcLBCdNhU4';
                
                const prompt = `Extract only the main brand name from: "${profileName}". 
Examples:
- "Amazon India" ‚Üí "Amazon"
- "Nike India" ‚Üí "Nike"
Return ONLY the brand name.`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const brandName = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                    if (brandName) return brandName;
                }
            } catch (error) {
                console.warn('Gemini AI failed:', error);
            }

            // Fallback: remove common suffixes
            return profileName
                .replace(/\s+(India|International|Official|Global|US|UK)\b/gi, '')
                .trim() || profileName.split(' ')[0];
        }

        async function fetchAdData(brandName) {
            const url = `https://api.brandbooster.ai/api/v1/research/brand-ads-count-public?brand_name=${encodeURIComponent(brandName)}`;
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`BrandBooster API failed (Status: ${response.status})`);
            }

            return await response.json();
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            setTimeout(() => testAutomation(), 500);
        });
    </script>
</body>
</html>

